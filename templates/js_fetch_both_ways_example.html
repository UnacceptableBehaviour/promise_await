{% extends 'nav_buttons_thin.html' %}

{% block header %}
<style>
    .repo{
      display: flex;
      background:#f4f4f4;
      padding:10px;
      margin-bottom:10px;
    }

    .repo ul{
      list-style: none;
      padding-left: 10px;
      margin-top:0px;
      margin-bottom:5px;
    }
</style>
{% endblock %}

{% block content %}


  <div class='container'>
    <div class="container-fluid">
      <button id='button-fetch-get'>Fetch GET</button>
      <button id='button-fetch-post'>Fetch POST</button>
      <button id='button-fetch-spare'>Spare</button>
    </div>
    <div id="simple-output"></div>
    <br>
    <div id="repos"></div>
  </div>
  
  <script>
    var repoData = {{ repo_data|tojson }};       // convert info using tojson filter      
    console.log(`repoData JS ${repoData['greeting']} - inline CONCLUDED`);  // sanity check
    
    var repoPostList = [];
    
    outputDiv = document.getElementById('simple-output')
    buttonGet = document.getElementById('button-fetch-get')
    buttonPost = document.getElementById('button-fetch-post')
    buttonSpare = document.getElementById('button-fetch-spare')
    
    outputDiv.innerHTML = repoData['greeting']
    
    
    //            function() { outputDiv.innerHTML = 'GET' }     
    buttonGet.addEventListener('click', fetchButtonGET )    
    // or         () => { outputDiv.innerHTML = 'POST' }    
    buttonPost.addEventListener('click', fetchButtonPOST )    
    // but not    function() => { outputDiv.innerHTML = 'POST' }    
    //buttonSpare.addEventListener('click', function() => { outputDiv.innerHTML = 'POST' } )


    userName = 'UnacceptableBehaviour';      
    console.log(`getting repos for user ${userName}`);
      
  
    function fetchButtonGET() {
      outputDiv.innerHTML = 'GET';

      fetch( `https://api.github.com/users/${userName}/repos` )
        .then( function(response) {
          return response.text();
        
        }).then( function(text) {
          //console.log(`GET response: ${text}`);      // should read "Rendered HTML from route"
          
          var repos = JSON.parse(text);

          var output = '';
          for(var i in repos){
            
            repoPostList.push(repos[i].name);    // populate array with repo names
            console.log(repoPostList);
            
            output +=
              '<div class="repo">' +
              '<img src="'+repos[i].owner.avatar_url+'" width="35" height="35">' +
              '<ul>' +
              '<li>repo: '+repos[i].name+'</li>' +
              '<li>'+repos[i].description+'</li>' +
              '</ul>' +
              '</div>';
          } 

          document.getElementById('repos').innerHTML = output;          

        });      

    }
    
    function fetchButtonPOST() {
      outputDiv.innerHTML = 'POST';
      
      fetch( '/js_fetch_test', {
        method: 'POST',                                             // method (default is GET)
        headers: {'Content-Type': 'application/json' },             // JSON
        //body: JSON.stringify( { 'greeting':"Hello from browser" } ) // Payload
        body: JSON.stringify( { 'repos':repoPostList } )            // New Payload        

      }).then( function(response) {
        return response.text();
      
      }).then( function(text) {
        console.log(`POST response: ${text}`);      // should read "POST response: OK"
      });
      
    }
    
    // method 2 - ajax - in script
    
    
    // method 3 - fetch API - built into browser
    
  </script>
  
  <!--<script src="static/callbacks.js"></script>-->  
  


{% endblock %}